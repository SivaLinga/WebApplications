package com.crmindz.controller;

import java.util.List;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.crmindz.model.Login;
import com.crmindz.model.Ticket;
import com.crmindz.model.User;
import com.crmindz.service.RegistrationService;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

@Controller
public class MainController {
	@Autowired
	RegistrationService registrationService;

	@RequestMapping(value = "/home")
	public String welcomePage(Model model) {
		return "home";
	}

	@RequestMapping(value = "/signup", method = RequestMethod.POST)
	public String register(User user, Model model) {
		System.out.println(user);

		if (registrationService.validateRegistration(user)) {
			System.out.println("Valid Registration Details..!!");
			if (registrationService.register(user))
				return "login";
			else
				return "registrationerror";
		} else {
			System.out.println("Account Already Exists");
			return "invalidregistration";
		}
	}

	@RequestMapping(value = "/login", method = RequestMethod.POST)
	public String login(Login login, ModelMap model, HttpSession session) {
		System.out.println(login);
		List<Login> loginDetailsFromDb = registrationService.validateLogin(login);
		String userPassword = loginDetailsFromDb.get(0).getPassword();
		model.put("login", login);
		if (loginDetailsFromDb.isEmpty() || !(userPassword.equals(login.getPassword()))) {
			return "loginerror";
		} else {
			String sessionID = session.getId();
			System.out.println(sessionID);
			session.setAttribute("sloginID", loginDetailsFromDb.get(0).getLoginId());
			String userType = loginDetailsFromDb.get(0).getUserType();
			if ("student".equals(userType) || "consultant".equals(userType))
			{
				return "studentloginsuccess";
			}
			else
				return "employeeloginsuccess";
		}
	}

	@RequestMapping(value = "/display")
	@ResponseBody
	public String retrieveTickets(Ticket ticket, ModelMap model, HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		ticket.setSessionAttribute(sessionAttribute);
		List<Ticket> listOfTickets = registrationService.displayTicketData(ticket);
		System.out.println(listOfTickets);
		Gson gson = new GsonBuilder().setPrettyPrinting().create();
		String jsonArray = gson.toJson(listOfTickets);
		// jsonArray = "{\"page\":1,\"total\":\"4\",\"records\":" + listOfTickets.size()
		// + ",\"rows\":" + jsonArray + "}";
		return jsonArray;
	}

	@RequestMapping(value = "/ticket", method = RequestMethod.GET)
	public String displayTickets(ModelMap model , HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		System.out.println(sessionAttribute);
		if (sessionAttribute != null) {
			model.put("login",sessionAttribute);
			return "studentticket";
		}

		else {
			System.out.println("Please Login First!!!");
			return "login";
		}
	}

	@RequestMapping(value = "/addTicket", method = RequestMethod.POST)
	public String addTikcet(Ticket ticket, Model model, HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		// System.out.println(ticket);
		if (sessionAttribute != null) {
			ticket.setSessionAttribute(sessionAttribute);
			ticket.setTstatus("pending");
			String ticketNumber = registrationService.generateTicketNumber();
			ticket.setTicketNumber(ticketNumber);
			if (registrationService.addTicket(ticket)) {
				return "studentticket";
			} else {
				System.out.println("Problem in adding Ticket");
				return "home";
			}
		} else {
			System.out.println("Please Login First");
			return "home";
		}
	}

	@RequestMapping(value = "/showTickets")
	public String displayAllTickets(HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		System.out.println(sessionAttribute);
		if (sessionAttribute != null) {
			return "employeeticket";
		}

		else {
			System.out.println("Please Login First!!!");
			return "login";
		}

	}

	@RequestMapping(value = "/displayPending")
	@ResponseBody
	public String retrievePendingTickets(Ticket ticket, ModelMap model, HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		ticket.setSessionAttribute(sessionAttribute);
		List<Ticket> pendingTickets = registrationService.displayPending();
		Gson gson = new GsonBuilder().setPrettyPrinting().create();
		String jsonArray = gson.toJson(pendingTickets);
		return jsonArray;
	}

	@RequestMapping(value = "/displayApproved")
	@ResponseBody
	public String retrieveApprovedTickets(Ticket ticket, ModelMap model, HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		ticket.setSessionAttribute(sessionAttribute);
		List<Ticket> approvedTickets = registrationService.displayApproved();
		Gson gson = new GsonBuilder().setPrettyPrinting().create();
		String jsonArray = gson.toJson(approvedTickets);
		return jsonArray;
	}

	@RequestMapping(value = "/displayRejected")
	@ResponseBody
	public String retrieveRejectedTickets(Ticket ticket, ModelMap model, HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		ticket.setSessionAttribute(sessionAttribute);
		List<Ticket> rejectedTickets = registrationService.displayRejected();
		Gson gson = new GsonBuilder().setPrettyPrinting().create();
		String jsonArray = gson.toJson(rejectedTickets);
		return jsonArray;
	}

	@RequestMapping(value = "/approveTicket", method = RequestMethod.POST)
	public String approveTicket(Ticket ticket, Model model, HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		if (sessionAttribute != null) {
			ticket.setSessionAttribute(sessionAttribute);
			ticket.setTstatus("approved");
			if (registrationService.approveTicket(ticket)) {
				return "employeeticket";
			} else {
				return "home";
			}
		} else {
			return "home";
		}
	}

	@RequestMapping(value = "/rejectTicket", method = RequestMethod.POST)
	public String rejectTicket(Ticket ticket, Model model, HttpSession session) {
		String sessionAttribute = (String) session.getAttribute("sloginID");
		System.out.println(ticket);
		if (sessionAttribute != null) {
			ticket.setSessionAttribute(sessionAttribute);
			ticket.setTstatus("rejected");
			if (registrationService.rejectTicket(ticket)) {
				return "employeeticket";
			} else {
				return "home";
			}
		} else {
			return "home";
		}
	}

	@RequestMapping(value = "logout", method = RequestMethod.GET)
	public String logout(HttpSession session) {
		session.invalidate();
		return "home";
	}

	@RequestMapping(value = "/getState", method = RequestMethod.GET)
	@ResponseBody
	public String getStates() {
		String listOfStates = registrationService.getStates();
		return listOfStates;
	}

	@RequestMapping(value = "/getCategories", method = RequestMethod.GET)
	@ResponseBody
	public String getCategories() {
		String categoryData = registrationService.getCategories();
		return categoryData;
	}

	@RequestMapping(value = "/getSubCategories", method = RequestMethod.GET)
	@ResponseBody
	public String getSubCategories(String categoryValue) {
		String subCategoriesData = registrationService.getSubCategories(categoryValue);
		return subCategoriesData;
	}

}
